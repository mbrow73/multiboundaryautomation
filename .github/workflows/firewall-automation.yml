name: "üîí Process Firewall Requests"
on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process:
    if: contains(github.event.issue.labels.*.name, 'firewall-request')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üìù Parse Issue & Generate JSON
        id: parse_and_write
        run: |
          set -e
          BODY=$(printf '%s' "${{ github.event.issue.body }}" | tr -d $'\r')
          REQID=$(echo "$BODY" | grep -i 'Request ID' | cut -d: -f2 | xargs)
          echo "REQID=$REQID" >> $GITHUB_OUTPUT

          # Split rule blocks and build JSON
          echo 'BEGIN JSON'
          # AWK or Python to pull src_ip, dest_ip, ports, protocol, desc
          # Write to firewall-requests/${REQID}.auto.tfvars.json

      - name: üó∫Ô∏è Map IPs to Boundaries
        shell: bash
        run: |
          python3 .github/scripts/boundary_mapper.py \
            --map-file boundary_map.json \
            --json-file firewall-requests/${{ steps.parse_and_write.outputs.REQID }}.auto.tfvars.json

      - name: ‚è´ Create or Update Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "[Firewall] ${{ steps.parse_and_write.outputs.REQID }}"
          branch: firewall/${{ steps.parse_and_write.outputs.REQID }}
          title: "Firewall Request ${{ steps.parse_and_write.outputs.REQID }}"
          body: |
            :robot: PR for firewall rules (${{ steps.parse_and_write.outputs.REQID }})
          add-paths: |
            firewall-requests/${{ steps.parse_and_write.outputs.REQID }}.auto.tfvars.json
          base: main